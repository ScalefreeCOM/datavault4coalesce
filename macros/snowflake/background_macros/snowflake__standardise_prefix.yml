fileVersion: 1
id: "17"
macroString: |-
    {%- macro datavault4coalesce__snowflake_standardise_prefix(case_sensitive, hash_alg, is_hashdiff, datatype, zero_key, alias, multi_active_key, main_hashkey_col) -%}
    {%- set dict_result = {} -%}
    {%- set zero_key = datavault4coalesce__snowflake_as_constant(column_str=zero_key) -%}
    {%- set listagg_opening = "" -%}

    {#-- If definition of multi-active key(s) is found, prep string variables:                      --#}
    {#--     multi_active_key: list of multi-active keys, concatenated with comma delimiter.        --#}
    {#--     listagg_opening : 1st part of LISTAGG window function, used in                         --#}
    {#--                       hashing calculation of multi-active satellite's hash diff attribute. --#}
    {%- if is_hashdiff and multi_active_key is defined and multi_active_key|length>0 -%}
        {%- set listagg_opening = "LISTAGG(" -%}
    {%- endif -%}

    {%- if 'VARCHAR' in datatype or 'CHAR' in datatype or 'STRING' in datatype or 'TEXT' in datatype %}
        {%- if case_sensitive -%}
            {%- set standardise_prefix = "IFNULL(LOWER({}({}NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg, listagg_opening)-%}
        {%- else -%}
            {%- set standardise_prefix = "IFNULL(LOWER({}({}NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg, listagg_opening)-%}
        {%- endif -%}

    {%- else -%}
        {%- if case_sensitive -%}
            {%- set standardise_prefix = "IFNULL({}({}NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg, listagg_opening)-%}
        {%- else -%}
            {%- set standardise_prefix = "IFNULL({}({}NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg, listagg_opening)-%}
        {%- endif -%}
    {%- endif -%}

    {{ standardise_prefix }}
    {%- endmacro -%}
name: snowflake__standardise_prefix
type: Macro