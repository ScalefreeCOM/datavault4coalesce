fileVersion: 1
id: "1"
macroString: |-  

  {%- macro datavault4coalesce__databricks_standardise_prefix(case_sensitive, hash_alg, is_hashdiff, datatype, zero_key, alias, multi_active_key, main_hashkey_col) -%}
  {%- set dict_result = {} -%}
  {%- set zero_key = datavault4coalesce__as_constant(column_str=zero_key) -%}
  {%- set listagg_opening = "" -%}

  {#-- If definition of multi-active key(s) is found, prep string variables:                      --#}
  {#--     multi_active_key: list of multi-active keys, concatenated with comma delimiter.        --#}
  {#--     listagg_opening : 1st part of LISTAGG window function, used in                         --#}
  {#--                       hashing calculation of multi-active satellite's hash diff attribute. --#}
  {%- if is_hashdiff and multi_active_key is defined and multi_active_key|length>0 -%}

       {%- if 'STRING' in datatype %}
            {%- if case_sensitive -%}
                 {%- set standardise_prefix = "IFNULL(LOWER({}(ARRAY_JOIN(SORT_ARRAY(ARRAY_AGG(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg)-%}
            {%- else -%}
                 {%- set standardise_prefix = "IFNULL(LOWER({}(ARRAY_JOIN(SORT_ARRAY(ARRAY_AGG(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg) -%}
            {%- endif -%}

       {%- else -%}
            {%- if case_sensitive -%}
                 {%- set standardise_prefix = "IFNULL(CAST({}(ARRAY_JOIN(SORT_ARRAY(ARRAY_AGG(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg)-%}
            {%- else -%}
                 {%- set standardise_prefix = "IFNULL(CAST({}(ARRAY_JOIN(SORT_ARRAY(ARRAY_AGG(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg)-%}
            {%- endif -%}
       {%- endif -%}

  {%- else -%}
       {%- if 'STRING' in datatype %}
            {%- if case_sensitive -%}
                 {%- set standardise_prefix = "IFNULL(LOWER({}(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg)-%}
            {%- else -%}
                 {%- set standardise_prefix = "IFNULL(LOWER({}(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg)-%}
            {%- endif -%}

       {%- else -%}
            {%- if case_sensitive -%}
                 {%- set standardise_prefix = "IFNULL(CAST({}(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(CONCAT(".format(hash_alg)-%}
            {%- else -%}
                 {%- set standardise_prefix = "IFNULL(CAST({}(NULLIF(CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(CONCAT(".format(hash_alg)-%}
            {%- endif -%}
       {%- endif -%}



  {%- endif -%}

  {{ standardise_prefix }}
  {%- endmacro -%}
name: datavault4coalesce__databricks_standardise_prefix
type: Macro